<style>body{max-width:650px;margin:20px auto;color:#252525}</style>
<h1>s3-bsync</h1>
<p>Bidirectional syncing tool to sync local filesystem directories with S3
buckets.  Written by <a href="https://joshstock.in">Josh Stockin</a>.</p>
<h3>Behavior</h3>
<p>After an initial sync (manually handling conflicts and uncommon files), the S3
bucket maintains precedence.  Files with the same size and modify time on both
hosts are ignored.  A newer copy of a file always overwrites the corresponding
old, regardless of changes in the old.  (In other words, <strong>there is no manual
conflict resolution after first sync.  Conflicting files are handled
automatically as described here.</strong>  This script is meant to run without input
or output by default, in a cron job for example.)  Untracked files, in either
S3 or on the local machine, are copied to the opposite host and tracked.
Tracked files that are moved or removed on either host are moved or removed on
the corresponding host, with the tracking adjusted accordingly.  Ultimately,
after a sync, the <code>.state.s3sync</code> state tracking file should match the contents
of the S3 bucket's synced directories.</p>
<h3>Installation</h3>
<p>Depends on <code>python3</code> and <code>aws-cli</code>.  Both can be installed with your package
manager.</p>
<p>Install with <code>python3 setup.py install</code>.  Root permissions not required.
<em>This program does not manage S3 authentication or <code>aws-cli</code> credentials. You
must do this yourself with the <code>aws configure</code> command, or other means of
IAM/S3 policy.</em></p>
<h4>Source files</h4>
<p><code>setup.py</code> manages installation metadata.</p>
<h4>Created files and .s3syncignore</h4>
<p>The default file used to store sync information is <code>~/.state.s3sync</code>, but this
location can be reconfigured.  The file uses the binary s3sync file format
specified later in this document.  If you want to intentionally ignore
untracked files, use a <code>.s3syncignore</code> file, in the same manner as
<a href="https://git-scm.com/docs/gitignore"><code>.gitignore</code></a>.</p>
<h2>s3sync file format</h2>
<p>The <code>.state.s3sync</code> file saved in home directory defines the state of tracked
objects from the specified S3 buckets and key prefixes used in the last sync.</p>
<h3>Control bytes</h3>
<pre><code>90 - Begin bucket block
91 - End bucket block
92 - Begin directory map
93 - End directory map
94 - Begin object block
95 - End object block
96 - ETag type MD5
97 - ETag type null-terminated string (non-MD5)
98
99
9A - Begin metadata block
9B - End metadata block
9C
9D - File signature byte
9E
9F - File signature byte
</code></pre>
<h3>File structure</h3>
<pre><code>Header {
    File signature - 4 bytes - 9D 9F 53 33
    File version   - 1 byte  - 01
}

Metadata block {
    Begin metadata block control byte - 9A
    Last synced time                  - 8 bytes uint
    End metadata block control byte   - 9B
}

Bucket block {
    Begin bucket block control byte - 90
    Bucket name                     - null-terminated string
    Directory map {
        Begin directory map block control byte - 92
        Path to local directory                - null-terminated string
        S3 key prefix                          - null-terminated string
        Recursive sync                         - 1 byte boolean
        End directory map block control byte   - 93
    }...
    Recorded object {
        Begin object block control byte - 94
        Key                             - null-terminated string
        Last modified time              - 8 bytes uint
        ETag type                       - 96 or 97
        ETag                            - 16 bytes or null-terminated string
        File size                       - 8 bytes uint
        End object block control byte   - 95
    }...
    End bucket block control byte - 91
}...
</code></pre>
<h2>Copyright</h2>
<p>This program is copyrighted by <a href="https://joshstock.in/">Joshua Stockin</a> and
licensed under the <a href="LICENSE">MIT License</a>.</p>
<p>A form of the following should be present in each source file.</p>
<pre><code class="language-txt">s3-bsync Copyright (c) 2021 Joshua Stockin
&lt;https://joshstock.in&gt;
&lt;https://git.joshstock.in/s3-bsync&gt;

This software is licensed and distributed under the terms of the MIT License.
See the MIT License in the LICENSE file of this project's root folder.

This comment block and its contents, including this disclaimer, MUST be
preserved in all copies or distributions of this software's source.
</code></pre>
<p>&lt;<a href="https://joshstock.in">https://joshstock.in</a>&gt; | <a href="mailto:josh@joshstock.in">josh@joshstock.in</a> | joshuas3#9641</p>
